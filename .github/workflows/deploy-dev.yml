name: Deploy to Dev
on:
  push:
    branches: [develop]
    paths-ignore:
      - "README.md"
      - "docs/**"
      - ".gitignore"
      - "terraform/**"
concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: true
permissions:
  id-token: write
  contents: read
env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: k8s-ci-cd-app
  EKS_CLUSTER_NAME: k8s-ci-cd-dev
  ENVIRONMENT: dev
jobs:
  ci:
    name: ğŸ” CI Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: app/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./app
        run: npm ci

      - name: ğŸ” Run lint
        working-directory: ./app
        run: npm run lint

      - name: ğŸ§ª Run tests
        working-directory: ./app
        run: npm test

  build:
    name: ğŸ—ï¸ Build & Push
    runs-on: ubuntu-latest
    needs: ci
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      image_uri: ${{ steps.build.outputs.image_uri }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ“‹ Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          IMAGE_TAG="${SHORT_SHA}-${TIMESTAMP}-dev"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: ğŸ³ Build and push Docker image
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          cd app
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

          docker build \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg GIT_SHA=${{ github.sha }} \
            --build-arg VERSION=${IMAGE_TAG} \
            -t ${IMAGE_URI} \
            -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest-dev \
            .

          docker push ${IMAGE_URI}
          docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest-dev

          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT

  deploy:
    name: ğŸš€ Deploy to Dev
    runs-on: ubuntu-latest
    needs: build
    environment: dev

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: ğŸ”— Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: ğŸ“ Update image in Kustomization
        run: |
          cd kustomize/overlays/dev
          kustomize edit set image app=${{ needs.build.outputs.image_uri }}

      - name: ğŸš€ Deploy to Kubernetes
        run: |
          kubectl apply -k kustomize/overlays/dev/

      - name: â³ Wait for rollout
        run: |
          kubectl rollout status deployment/app -n app-dev --timeout=300s

      - name: âœ… Verify deployment
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n app-dev -l app.kubernetes.io/name=k8s-ci-cd

  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”— Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: ğŸ¥ Run health check
        run: |
          kubectl port-forward svc/app-service 8080:80 -n app-dev &
          sleep 10

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")

          if [ "$HTTP_STATUS" == "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed! (HTTP $HTTP_STATUS)"
            exit 1
          fi
